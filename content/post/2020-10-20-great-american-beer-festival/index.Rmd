---
title: Great American Beer Festival
author: badbayesian
date: '2020-10-20'
slug: great-american-beer-festival
categories:
  - R
  - tidytuesday
subtitle: "Exploring #TidyTuesday [Great American Beer Festival](https://www.greatamericanbeerfestival.com/the-competition/winners/) to find how and which states specialized in making award winning beers."
summary: "Exploring #TidyTuesday [Great American Beer Festival](https://www.greatamericanbeerfestival.com/the-competition/winners/) to find how and which states specialized in making award winning beers."
lastmod: '2020-10-20T13:38:44-05:00'
featured: no
---

```{r setup, include=FALSE}
library(hrbrthemes)
library(RColorBrewer)
getPalette = colorRampPalette(brewer.pal(17, "Set1"))
knitr::opts_chunk$set(fig.width=12, fig.height=10)
loc <- paste0(rprojroot::find_rstudio_root_file(), "/content/post/2020-10-20-great-american-beer-festival/")
setwd(loc)
knitr::opts_chunk$set(root.dir = loc)

```

This week, we explore which beer styles and categories are are over/under represented in different states and over time.

## Exploring the data

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(fuzzyjoin)
library(stringdist)
library(tigris)

beer_styles <- read_csv("beer_styles.csv")

state_info <- fips_codes %>%
  group_by(state) %>%
  slice(1) %>%
  select(state, state_name)

beer_awards <- readr::read_csv(
  paste0("https://raw.githubusercontent.com/rfordatascience/tidytuesday/",
         "master/data/2020/2020-10-20/beer_awards.csv")) %>%
  mutate(brewery = str_replace(brewery, " Company", ""),
         brewery = str_replace(brewery, " Co.", ""))

beers <- read_csv("beers.csv") %>%
  select(-X1)
breweries <- read_csv("breweries.csv") %>% 
  mutate(name = str_replace(name, " Company", ""),
         name = str_replace(name, " Co.", "")) %>%
  inner_join(state_info, by="state")

beer_joined <- breweries %>%
  inner_join(beers, by="brewery_id") %>%
  rename(brewery_name = name.x,
         beer_name = name.y) %>%
  full_join(beer_awards,
            by=c("city"="city",
                 "state"="state",
                 "brewery_name"="brewery",
                 "beer_name"="beer_name")) %>%
  inner_join(state_info, by="state") %>%
  mutate(state_name = if_else(is.na(state_name.x),
                              state_name.y, state_name.x)) %>%
  select(-state_name.x, -state_name.y) %>%
  rename(style2 = style)

beer_awards_joined <- beer_joined %>%
  mutate(category = case_when(
    is.na(category) & !is.na(style2) ~ style2,
    is.na(category) & is.na(style2) ~ beer_name,
    TRUE ~ category)) %>%
  mutate(category = str_replace_all(category, "-", " "),
         category = str_replace_all(category, "Ale, ", ""),
         category = str_replace_all(category, "Lager, ", "")) %>%
  select(-id, -style2) %>%
  stringdist_left_join(beer_styles, by = c("category"="category")) %>%
  mutate(category = str_to_lower(if_else(is.na(category.x), category.y, category.x))) %>%
  select(-category.y, -category.x) %>%
  mutate(category = case_when(
    str_detect(category, "dry stout") &
      !str_detect(category, "irish") ~ "dry stout",
    str_detect(category, "foreign style|export") &
      style == "Stouts" ~ "foreign style stout",
    TRUE ~ category),
    style = case_when(
      str_detect(category, "brown") ~ "Brown Ales",
      str_detect(category, "dark lager|o*tober|dark pils") ~ "Dark Lagers",
      str_detect(category, "dark ale") ~ "Dark Ales",
      str_detect(category, "gose|wild|fruit|brett|sour") ~ "Wild/Sour Beers",
      str_detect(category, "wheat|style weisse") ~ "Wheat Beers",
      str_detect(category, "cream") ~ "Hybrid Beers",
      str_detect(category, "spice|special|alcoholic") ~ "Specialty Beers",
      str_detect(category, "pils|bitter|amber ale|light lager|zwickelbier|helles") ~ "Pale Ales",
      str_detect(category, "pale ale") & !str_detect(category, "india") ~ "Pale Ales",
      str_detect(category, "strong ale") ~ "Strong Ales",
      str_detect(category, "india pale ale") ~ "India Pale Ales",
      TRUE ~ style)) %>%
  filter(!((category == "American IPA") & (style == "American IPA"))) %>%
  mutate(winner = !is.na(medal),
         category = str_to_title(category)) %>%
  filter(winner) %>%
  distinct()
```
There are `r length(unique(beer_awards_joined$category))` different categories with on average `r round(mean(table(beer_awards_joined$category)), 2)` beers in each category. With such a low sample size per category, the statistical power will be too low for most models especially time series or geospatial models. As such, we can aggregate `beer category` to `beer style`, as defined by [Beer Advocate](https://www.beeradvocate.com/beer/styles/), to created larger buckets and increase the sample size per bucket. Now, the larger set of beers has only `r length(unique(beer_awards_joined$style))` different buckets with on average `r round(mean(table(beer_awards_joined$style)), 2)` beers in each style. As we then cut on state (50+1) and time (1987 - 2020), we can be assured that enough data will be within most buckets so that the analysis has sufficient power.

```{r}
beer_style_counts <- beer_awards_joined %>%
  mutate(style = if_else(is.na(style), " NA", style),
         style = fct_reorder(style, desc(style))) %>%
  count(style)

beer_style_counts %>% 
  ggplot() +
  aes(y=style, x=n, fill=style) +
  geom_col(position = "dodge") +
  theme_ipsum_ps(axis_title_size = 15, plot_title_size = 25) +
  labs(x = "Count", y = "Beer Styles", title = "Number of Beer Styles") +
  theme(legend.position = "none") +
  scale_fill_manual(values = getPalette(15))
```

```{r, message=FALSE}
beer_awards_joined %>%
  mutate(style = if_else(is.na(style), " NA", style)) %>%
  count(style, category) %>%
  group_by(style) %>%
  summarise(category_numbers = n()) %>%
  inner_join(beer_style_counts, by="style") %>%
  mutate(style = fct_reorder(style, desc(style))) %>%
  ggplot() +
  aes(x=category_numbers, y=style, fill=style) +
  geom_col(position = "dodge") +
  geom_text(aes(label = paste0("n=", n)),
            size=3,
            nudge_x = -2,
            nudge_y = -0.25) +
  theme_ipsum_ps(axis_title_size = 15, plot_title_size = 25) +
  labs(x = "Count", y = "Beer Styles", title = "Number of Beer Categories per Beer Style") +
  theme(legend.position = "none") +
  scale_fill_manual(values = getPalette(15))
```

## Modeling questions

One would imagine that different states may specialize in different categories or styles of beer. We can model this using `Log Odds` which creates a statistic of the strength of the relationship between two events. In our example, we might ask what beer categories are over/under represented in a given state. This may indicate a beverage specialization and perhaps a consumer preference for that state.

```{r}
library(tidylo)
library(tidytext)

log_odds <- beer_awards_joined %>%
  filter(fct_lump(category, 8) != "Other",
         fct_lump(state, 4) != "Other") %>%
  count(state, category, style) %>%
  complete(state, category, fill = list(n=0)) %>%
  bind_log_odds(state, category, n, uninformative = TRUE, unweighted = TRUE) %>%
  mutate(category = reorder_within(category, log_odds_weighted, state),
         style = if_else(is.na(style), "Bocks", style))


log_odds %>%
  ggplot() +
  aes(x=log_odds_weighted, y=category, fill=style) +
  geom_col() +
  scale_y_reordered() +
  facet_wrap(~ state, nrow = 4, scale = "free_y") +
  labs(y = "Beer Category", x = "Weighted Log Odds", fill = "Beer style",
       title = "Over/Under representation of different beer categories\n per US State") +
  theme_ipsum_ps(axis_title_size = 15, plot_title_size = 20) +
  scale_fill_manual(values = getPalette(8))
```

The analysis suggest that `beer categories`: Irish Dry and Imperial are more likely to come from California while Bock and (German/Bohemian) Pilseners are more likely to come from Colorado. Interestingly, some of the states have strong reversals in their log odds in comparison to other states suggesting states are specializing in thier beers.

We can also specifically look at `beer styles` to to check the robustness of the claim.

```{r}
beer_awards_joined %>%
  filter(fct_lump(state, 4) != "Other",
         fct_lump(style, 8) != "Other") %>%
  count(state, style) %>%
  complete(state, style, fill = list(n=0)) %>%
  bind_log_odds(state, style, n) %>%
  mutate(style = reorder_within(style, log_odds_weighted, state),
         beer_style = sub("__.*", "", style)) %>%
  ggplot() +
  aes(x=log_odds_weighted, y=style, fill=beer_style) +
  geom_col() +
  scale_y_reordered() +
  facet_wrap(~ state, nrow = 4, scale = "free_y") +
  labs(y = "Beer style", x = "Weighted Log Odds", fill = "Beer style",
       title = "Over/Under representation of different beer styles\n per US State.") +
  theme(text = element_text(size = 15)) +
  theme_ipsum_ps(axis_title_size = 15, plot_title_size = 25) +
  scale_fill_manual(values = getPalette(8))
```

Aggregating the data still shows evidence of beer specialization per state. Some aspects if the specialization claim was over stated as the `Robust Porter` is over represented in California, however, `Porters` in general are not. Various specific categories of `Wheat Beers` are only vaguely over/under represented , the beer style of `Wheat Beers` are over represented in Colorado and under presented in California. Alternatively, in Texas, the `German Style Wheat Ale` is very over represented however, `Wheat Beers` in general are not. `Dark Largers` beer style is very positive in Colorado and Texas and are very negative in California and Oregon. However, no specific category of dark lagers are particularly over/under representation.

We can also view this plot throughout the US as a proxy for specialization zones in the US.

```{r}
library(geofacet)
beer_awards_joined %>%
  filter(fct_lump(style, 8) != "Other") %>%
  count(state, style) %>%
  complete(state, style, fill = list(n=0)) %>%
  bind_log_odds(state, style, n) %>%
  mutate(style = reorder_within(style, log_odds_weighted, state),
         beer_style = sub("__.*", "", style)) %>%
  ggplot() +
  aes(x=log_odds_weighted, y=reorder(beer_style, desc(beer_style)), fill=beer_style) +
  geom_col() +
  facet_geo(~ state, grid = "us_state_grid2") +
  scale_y_reordered() +
  theme_bw() +
  scale_fill_manual(values = getPalette(8)) +
  labs(x="Weighted Log-Odds", y="Beer Styles", fill="Beer Styles",
       title = "Weighted Log-Odds of different Beer Styles throughout the US")
```




Lastly, we can regress number of specific beer style with year to see if any beer styles are becoming more popular over time.

```{r, warnings=FALSE, message=FALSE}
library(broom)
by_year_style <- beer_awards_joined %>%
  add_count(year, name = "year_total") %>%
  count(style, year, year_total, sort = TRUE) %>%
  mutate(pct_year = n / year_total)

over_under <- by_year_style %>%
  group_by(style) %>%
  summarize(model = list(glm(cbind(n, year_total - n) ~ year, family = "binomial"))) %>%
  mutate(tidied = map(model, tidy, conf.int = TRUE)) %>%
  unnest(tidied) %>%
  filter(term == "year") %>%
  mutate(p.value = format.pval(round(p.value, 2)),
         style = fct_reorder(style, estimate))

over_under %>%
  ggplot() +
  aes(x=estimate, y=style) +
  geom_point(size=3) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = .1, size=1) +
  theme_bw() +
  labs(x = "Estimated slope",
       title = "Which beers styles are increasingly winning more\n over time throughout the US?",
       y = "") +
  theme(text = element_text(size = 15)) +
  theme_ipsum_ps(axis_title_size = 15, plot_title_size = 25)
```


```{r, include=FALSE, echo=FALSE}

by_year_state_style <- beer_awards_joined %>%
  add_count(year, name = "year_total") %>%
  mutate(state = fct_lump(state, 4)) %>%
  count(style, state, year, year_total, sort = TRUE) %>%
  mutate(pct_year = n / year_total)

by_year_state_style %>%
  mutate(style = fct_lump(style, 5)) %>%
  filter(!state %in% c(NA, "Other")) %>%
  ggplot() +
  aes(x=year, y=pct_year, color=style) +
  geom_line(size=1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ state, ncol = 2) +
  theme_bw() +
  labs(y = "% per year", x = "Year", color = "Beer styles") +
  theme_ipsum_ps(axis_title_size = 15, plot_title_size = 25)
```
